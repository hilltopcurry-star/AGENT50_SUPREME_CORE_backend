<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent 50 - Admin HQ (FINAL FIX)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
        .login-container { max-width: 400px; margin: 80px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .dashboard { display: none; }
        .stat-card { color: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .bg-purple { background: linear-gradient(45deg, #6a11cb, #2575fc); }
        .bg-orange { background: linear-gradient(45deg, #ff9966, #ff5e62); }
        .bg-green { background: linear-gradient(45deg, #11998e, #38ef7d); }
        .bg-blue { background: linear-gradient(45deg, #2193b0, #6dd5ed); }
        .menu-box { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 5px solid #2575fc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .proof-img { max-width: 100%; border: 2px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="loginScreen" class="container">
        <div class="login-container text-center">
            <h1 class="mb-4">üëë Agent 50</h1>
            <h5 class="text-muted mb-4">Command Center</h5>
            <input type="email" id="email" class="form-control mb-3" placeholder="Email Address">
            <input type="password" id="password" class="form-control mb-3" placeholder="Password">
            <button class="btn btn-primary w-100 btn-lg" onclick="login()">Login</button>
            <p class="mt-3 text-muted small">Super Admin: admin@agent50.com / admin123</p>
        </div>
    </div>

    <div id="dashboardScreen" class="dashboard container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4 px-3">
            <div>
                <h2 id="welcomeMsg" class="fw-bold text-dark">Dashboard</h2>
                <span id="roleBadge" class="badge bg-dark">Checking Role...</span>
            </div>
            <button class="btn btn-outline-danger" onclick="logout()">üö™ Logout</button>
        </div>

        <div class="row px-3">
            <div class="col-md-3"><div class="stat-card bg-green"><h3>Total Sales</h3><h2 id="totalSales">Rs 0</h2></div></div>
            <div class="col-md-3"><div class="stat-card bg-blue"><h3>Total Orders</h3><h2 id="totalOrders">0</h2></div></div>
            <div class="col-md-3"><div class="stat-card bg-orange"><h3>Today's Orders</h3><h2 id="todayOrders">0</h2></div></div>
            <div class="col-md-3"><div class="stat-card bg-purple"><h3>Active Status</h3><h2>Live üü¢</h2></div></div>
        </div>

        <div class="row px-3 mt-4">
            <div class="col-md-8">
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center bg-white">
                        <h5 class="m-0 font-weight-bold text-primary">üì¶ Live Orders & Proofs</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadDashboard()">üîÑ Refresh</button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Date</th>
                                        <th>Items</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Proof</th>
                                    </tr>
                                </thead>
                                <tbody id="orderTableBody">
                                    <tr><td colspan="6" class="text-center">Loading Data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="profileSection" class="card p-3 mb-4 shadow-sm" style="display:none;">
                    <h4>üë§ Business Profile</h4>
                    <div class="input-group mt-2">
                        <input type="text" id="resPhone" class="form-control" placeholder="Contact Phone">
                        <input type="text" id="resEmail" class="form-control" placeholder="Email Address">
                        <button class="btn btn-dark" onclick="updateProfile()">Save Details</button>
                    </div>
                </div>

                <div id="menuContainer"></div>
            </div>

            <div class="col-md-4">
                <div id="adminControls" style="display:none;">
                    <div class="card p-3 mb-4 shadow-sm border-primary">
                        <h4 class="text-primary">‚ö° Super Actions</h4>
                        <button class="btn btn-success w-100 mt-2" onclick="addRestaurant()">üè¢ Add New Restaurant</button>
                    </div>
                    
                    <div class="card p-3 shadow-sm border-warning mb-4">
                        <h4 class="text-warning">üëî Create Manager</h4>
                        <input type="email" id="newMgrEmail" class="form-control mb-2" placeholder="Manager Email">
                        <input type="password" id="newMgrPass" class="form-control mb-2" placeholder="Password">
                        <select id="resSelector" class="form-control mb-2"></select>
                        <button class="btn btn-warning w-100" onclick="createManager()">Create Manager</button>
                    </div>

                    <div class="card p-3 shadow-sm border-info mt-3">
                        <h4 class="text-info">üöö Create Delivery Rider</h4>
                        <input type="email" id="driverEmail" class="form-control mb-2" placeholder="Rider Email (Login ID)">
                        <input type="password" id="driverPass" class="form-control mb-2" placeholder="Password">
                        <input type="text" id="driverName" class="form-control mb-2" placeholder="Rider Name">
                        <input type="text" id="driverPhone" class="form-control mb-2" placeholder="Phone Number">
                        <button class="btn btn-info w-100 text-white" onclick="createDriver()">Create Rider Account</button>
                    </div>
                    </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="proofModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üì∏ Delivery Proof</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" class="proof-img" alt="Delivery Proof">
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ‚úÖ API URL (Same as server)
    const API = "https://agent50-supreme-core-backend-server.onrender.com";
    let USER = null;

    async function login() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        try {
            const res = await fetch(API + '/login', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email: e, password: p})
            });
            const data = await res.json();
            if (data.error) return alert(data.error);
            
            USER = data;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
            document.getElementById('welcomeMsg').innerText = `Welcome, ${data.email}`;
            document.getElementById('roleBadge').innerText = data.role === 'super_admin' ? 'üëë Super Admin' : 'üë®‚Äçüç≥ Manager';
            
            if(data.role === 'super_admin') {
                document.getElementById('adminControls').style.display = 'block';
            } else {
                document.getElementById('profileSection').style.display = 'block';
            }
            loadDashboard();
        } catch(e) { alert("Connection Failed"); }
    }

    async function loadDashboard() {
        try {
            const res = await fetch(API + '/dashboard/data', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({role: USER.role, restaurant_id: USER.restaurant_id})
            });
            const data = await res.json();

            document.getElementById('totalSales').innerText = 'Rs ' + (data.stats.sales_today || 0);
            document.getElementById('totalOrders').innerText = data.stats.total_orders || 0;
            document.getElementById('todayOrders').innerText = data.orders.length;

            const tbody = document.getElementById('orderTableBody');
            tbody.innerHTML = '';
            
            if(data.orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No orders found yet.</td></tr>';
            } else {
                data.orders.forEach(o => {
                    let statusBadge = 'bg-secondary';
                    if(o.status === 'Pending') statusBadge = 'bg-warning text-dark';
                    if(o.status === 'Preparing') statusBadge = 'bg-info text-dark';
                    if(o.status === 'Ready') statusBadge = 'bg-primary';
                    if(o.status === 'Accepted') statusBadge = 'bg-purple';
                    if(o.status === 'Delivered') statusBadge = 'bg-success';

                    let proofBtn = '<span class="text-muted">-</span>';
                    if(o.proof_image) {
                        window[`img_${o.id}`] = o.proof_image; 
                        proofBtn = `<button class="btn btn-sm btn-outline-dark" onclick="showProof('${o.id}')">üì∏ View Photo</button>`;
                    }

                    const row = `
                        <tr>
                            <td><small>${o.id.slice(0, 6)}</small></td>
                            <td><small>${o.date}</small></td>
                            <td>${o.items.join(', ')}</td>
                            <td><strong>Rs ${o.total_amount}</strong></td>
                            <td><span class="badge ${statusBadge}">${o.status}</span></td>
                            <td>${proofBtn}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }

            const select = document.getElementById('resSelector');
            select.innerHTML = '<option value="">Select Restaurant</option>';
            data.restaurants.forEach(r => {
                select.innerHTML += `<option value="${r.id}">${r.name}</option>`;
            });

            const container = document.getElementById('menuContainer');
            container.innerHTML = '<h3>ü•£ Menu Management</h3><hr>';
            
            data.restaurants.forEach(r => {
                if(USER.role === 'manager') {
                    document.getElementById('resPhone').value = r.phone || '';
                    document.getElementById('resEmail').value = r.email || '';
                }
                let html = `<div class="card mb-4 shadow-sm">
                    <div class="card-header bg-dark text-white d-flex justify-content-between">
                        <h4>${r.name}</h4>
                        <button class="btn btn-sm btn-warning" onclick="addCat('${r.id}')">+ Category</button>
                    </div>
                    <div class="card-body">`;
                r.menu.forEach(c => {
                    let items = c.items.map(i => `
                        <li class="list-group-item d-flex justify-content-between">
                            <span>${i.name} - <b>Rs ${i.price}</b></span>
                            <button class="btn btn-sm btn-danger" onclick="delItem('${r.id}', '${c.category}', '${i.name}')">√ó</button>
                        </li>`).join('');
                    html += `<div class="menu-box"><h5>üìÇ ${c.category}</h5><ul class="list-group mb-2">${items}</ul>
                            <div class="input-group input-group-sm">
                                <input id="n-${r.id}-${c.category}" type="text" class="form-control" placeholder="Item">
                                <input id="p-${r.id}-${c.category}" type="number" class="form-control" placeholder="Price">
                                <button class="btn btn-success" onclick="addItem('${r.id}', '${c.category}')">Add</button>
                            </div></div>`;
                });
                html += `</div></div>`;
                container.innerHTML += html;
            });

        } catch(e) { console.log(e); }
    }

    function showProof(oid) {
        const base64Img = window[`img_${oid}`];
        if(base64Img) {
            document.getElementById('modalImage').src = base64Img;
            new bootstrap.Modal(document.getElementById('proofModal')).show();
        } else {
            alert("Error loading image.");
        }
    }

    async function updateProfile() {
        const phone = document.getElementById('resPhone').value;
        const email = document.getElementById('resEmail').value;
        await post('/restaurant/update_profile', {id: USER.restaurant_id, phone, email});
        alert("Profile Updated!");
    }
    
    async function createManager() {
        const e = document.getElementById('newMgrEmail').value;
        const p = document.getElementById('newMgrPass').value;
        const rid = document.getElementById('resSelector').value;
        if(!e || !p || !rid) return alert("Fill all fields");
        await fetch(API + '/admin/create_manager', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({email: e, password: p, restaurant_id: rid}) });
        alert("Manager Created!");
    }

    // ‚úÖ‚úÖ‚úÖ NEW DRIVER FUNCTION ADDED HERE ‚úÖ‚úÖ‚úÖ
    async function createDriver() {
        const e = document.getElementById('driverEmail').value;
        const p = document.getElementById('driverPass').value;
        const n = document.getElementById('driverName').value;
        const ph = document.getElementById('driverPhone').value;

        if(!e || !p || !n) return alert("Please fill all Rider details!");

        try {
            const res = await fetch(API + '/admin/create_driver', { 
                method: 'POST', 
                headers: {'Content-Type':'application/json'}, 
                body: JSON.stringify({email: e, password: p, name: n, phone: ph}) 
            });
            const data = await res.json();
            if(data.error) {
                alert("Error: " + data.error);
            } else {
                alert("üéâ Rider Created Successfully!");
                // Clear fields
                document.getElementById('driverEmail').value = '';
                document.getElementById('driverPass').value = '';
                document.getElementById('driverName').value = '';
                document.getElementById('driverPhone').value = '';
            }
        } catch(err) {
            console.error(err);
            alert("Connection Error! Backend check karein.");
        }
    }

    async function addRestaurant() {
        let name = prompt("Restaurant Name:");
        if(name) { await post('/admin/restaurant/add', {name: name}); loadDashboard(); }
    }
    async function addCat(rid) {
        let cat = prompt("Category Name:");
        if(cat) await post('/admin/category/add', {restaurant_id: rid, category: cat});
    }
    async function addItem(rid, cat) {
        let name = document.getElementById(`n-${rid}-${cat}`).value;
        let price = document.getElementById(`p-${rid}-${cat}`).value;
        if(name && price) await post('/admin/menu/add', {restaurant_id: rid, category: cat, name, price});
    }
    async function delItem(rid, cat, name) {
        if(confirm("Delete?")) await post('/admin/menu/delete', {restaurant_id: rid, category: cat, name});
    }
    async function post(url, data) {
        await fetch(API + url, {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data)});
        document.getElementById('menuContainer').innerHTML = ''; 
        loadDashboard();
    }
    function logout() { location.reload(); }
</script>
</body>
</html>